# Modality Prediction Pipeline
Это пайплайн создания посылки для задачи Modality Prediction.

## Как создать посылку
1) Замените в `script.py` вызов `main` бейзлайна на желаемый `main`.
2) Выполните, чтобы сгенерировать `submission.zip`
    ```bash
    ./scripts/2_generate_submission.sh
    ```

## Как проверить посылку
Запустите скрипт для подсчета метрик:
```bash
./scripts/3_evaluate_submission.sh
```

## Что еще можно
1) Запустите код без компиляции:
    ```bash
    python script.py
    ```
2) Запустите юнит-тесты (сейчас они не работают):
    ```bash
    ./scripts/1_unit_test.sh
    ```

## Как это работает
Главный код, который делает предсказания, находится в `script.py`. Он читает входные данные и передает их в функцию `predict_submission`. Функция `predict_submission` принимает четыре аргумента:
```python
input_train_mod1 -- train данные первой модальности
input_train_mod2 -- train данные второй модальности
input_test_mod1 -- test данные первой модальности
resources_dir -- путь к папке с `lab_scripts`, `configs` и `checkpoints`. 
    Если вы запускаете `script.py` вне контейнера, там будет пустая строка, 
    потому что папки с ресурсами находятся в текущей директории. 
    Когда `script.py` запускается в контейнере, туда будет 
    передаваться путь к ресурсам.
```
Эта функция должна вернуть AnnData объект с предсказаниями второй модальности для наблюдений из `input_test_mod1`. Использовать train-данные необязательно.

Если ваша функция `main` поддерживает такую сигнатуру и использует данные только из папок `checkpoints`, `configs` и `lab_scripts`, создание посылки должно работать. Если создание посылки падает из-за ненайденных пакетов, добавьте пакет в докер (см. *Как добавить пакет в сборку*). Если вам нужна более тонкая настройка, изучите как работает пайплайн, чтобы модифицировать его.

### Общая идея
Когда вы запускаете скрипт `2_generate_submission.sh`, происходит следующее:
1) Он запускает компиляцию с помощью [viash](https://viash.io/) на основе файла конфигурации `config.vsh.yaml`.
2) Viash создает сборку с Docker.
3) Viash создает сборку с Nextflow.
4) Скрипт скачивает датасеты в `output/datasets`, если там их еще нет.
5) Скрипт использует сборку с Nextflow для того, чтобы сделать предсказания и сохранить их в `output/predictions`
6) Сборки и предсказания упаковываются в архив `submission.zip`

### Тонкости
- В конфиге `config.vsh.yaml` есть раздел `resources`, который указывает включить в сборку `script.py`, а также папки `lab_scripts`, `checkpoints` и `configs`. В финальной сборке эти ресурсы будут лежать в одной папке.
- В `script.py` есть блок `VIASH START` `VIASH END`, который будет удален во время сборки, а на его месте будут загружены параметры и аргументы. Так viash передает файлы датасетов для исполнения. Почему же в этом блоке есть код, если он будет удален? Это нужно для запуска `python script.py` без сборки для дебага.
- В целом, у viash понятная документация, но мы используем недокументируемую фичу. В `script.py` мы используем словарь `meta`, чтобы он видел включенные в сборку ресурсы. 
- В текущей папке находятся софтлинки на `lab_scripts`, `checkpoints` и `configs`. Это не нужно для сборки (во время сборки viash берет оригинальные папки из корня репозитория), но нужно для дебажного запуска `python script.py`.
- Если что-то непонятно, читайте в следующем порядке:
    - [Using StarterKits](https://openproblems.bio/neurips_docs/submission/starter_kits/)
    - [Viash](https://viash.io/)
    - `script.py`
    - `config.vsh.yaml`
    - ./scripts/*.sh
    - [Пайплайн](https://github.com/openproblems-bio/neurips2021_multimodal_viash), который вызывается из внутренних скриптов

## FAQ
### Как добавить пакет в сборку
Смотри пример в `config.vsh.yaml` в разделе `platforms`. Там можно указать pip-пакеты и apt-get-пакеты.

### `script.py` работает локально, но сборка не работает
На это может быть несколько причин. 

Если у вас не получается обратится к какому-нибудь локальному ресурсу (файлу конфигураций или скрипту), убедитесь, что он попадает в сборку. Это указано в `config.vsh.yaml` в разделе `resources`. 

Если ваша сборка не может найти какую-нибудь библиотеку, проверьте, что вы установили этот пакет в сборку (См. "Как добавить пакет в сборку").

### Как отладить работу в контейнере
Во время выполнения `scripts/2_generate_submission.sh` создается лог nextflow: `.nextflow.log` в текущей директории. Найдите там интересующий процесс и найдите строчку типа: 
```bash
status: COMPLETED; exit: 1; error: -; workDir: /home/user/nips/pipelines/modality_prediction/work/70/3a0dc77556d4941cda70e99bb5c20f
```
В папке `workDir` находятся логи и stdout главного скрипта.

### Почему меня не хватает ОЗУ
При стандартных настройках, nextflow запрашивает 10 гигабайт оперативной памяти, даже если скрипт этого не требует. С этим сталкивался Дима, и здесь будет инструкция, как это поправить.

### Чем эта папка отличается от авторского quickstart
Мы стараемся менять содержимое по минимуму, чтобы пайплайн было легко обновить, когда авторы выложат новую версию. Сейчас изменены только:
- В `config.vsh.yaml` добавлены папки с ресурсами и пакеты для докера
- Изменена логика `script.py`
- Добавленны симлинки на ресурсы: `lab_scripts`, `configs` и `checkpoints`